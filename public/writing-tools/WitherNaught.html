<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WitherNaught</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,300;0,400;0,500;1,300;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;1,9..40,400&display=swap" rel="stylesheet">
  <style>
    :root {
      --ease-out-expo: cubic-bezier(0.16, 1, 0.3, 1);
      --ease-in-out-sine: cubic-bezier(0.37, 0, 0.63, 1);
    }

    body { 
      font-family: 'Cormorant Garamond', Georgia, serif; 
    }
    .font-sans { 
      font-family: 'DM Sans', system-ui, sans-serif; 
    }

    /* Noise texture overlay */
    .noise-bg::before {
      content: '';
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.025;
      pointer-events: none;
      z-index: 1000;
    }

    /* Animations */
    @keyframes fade-in { 
      from { opacity: 0; } 
      to { opacity: 1; } 
    }
    @keyframes slide-up { 
      from { opacity: 0; transform: translateY(20px); } 
      to { opacity: 1; transform: translateY(0); } 
    }
    @keyframes scale-in { 
      from { opacity: 0; transform: scale(0.95); } 
      to { opacity: 1; transform: scale(1); } 
    }
    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-8px); }
    }
    @keyframes spark-float {
      0% { transform: translate(0, 0) scale(0); opacity: 0; }
      15% { opacity: 1; transform: translate(calc(var(--drift) * 0.1), -20px) scale(1); }
      100% { transform: translate(var(--drift), -180px) scale(0.3); opacity: 0; }
    }
    @keyframes spark-twinkle {
      0%, 100% { opacity: 0; transform: scale(0); }
      20% { opacity: 1; transform: scale(1.2); }
      40% { opacity: 0.6; transform: scale(0.8); }
      60% { opacity: 1; transform: scale(1); }
      80% { opacity: 0.4; transform: scale(0.6); }
    }
    @keyframes spark-burst {
      0% { transform: translate(0, 0) scale(0); opacity: 0; }
      20% { opacity: 1; transform: scale(1.5); }
      100% { transform: translate(var(--drift), var(--rise)) scale(0); opacity: 0; }
    }
    @keyframes spark-spiral {
      0% { transform: translate(0, 0) rotate(0deg) scale(0); opacity: 0; }
      20% { opacity: 1; transform: rotate(90deg) scale(1); }
      100% { transform: translate(var(--drift), -160px) rotate(720deg) scale(0.2); opacity: 0; }
    }
    @keyframes spark-glow-pulse {
      0%, 100% { box-shadow: 0 0 8px var(--glow-color), 0 0 16px var(--glow-color); }
      50% { box-shadow: 0 0 20px var(--glow-color), 0 0 40px var(--glow-color), 0 0 60px var(--glow-color); }
    }
    @keyframes pulse-ring {
      0% { transform: scale(1); opacity: 0.4; }
      100% { transform: scale(2); opacity: 0; }
    }
    @keyframes shimmer {
      0% { background-position: -200% 0; }
      100% { background-position: 200% 0; }
    }
    @keyframes breathe {
      0%, 100% { opacity: 0.15; }
      50% { opacity: 0.25; }
    }
    @keyframes score-pop {
      0% { transform: scale(1); }
      50% { transform: scale(1.08); }
      100% { transform: scale(1); }
    }

    .animate-fade-in { animation: fade-in 0.8s var(--ease-out-expo) forwards; }
    .animate-slide-up { animation: slide-up 0.8s var(--ease-out-expo) forwards; }
    .animate-scale-in { animation: scale-in 0.6s var(--ease-out-expo) forwards; }
    .animate-float { animation: float 6s var(--ease-in-out-sine) infinite; }
    .animate-spark-float { animation: spark-float ease-out forwards; }
    .animate-spark-twinkle { animation: spark-twinkle ease-in-out forwards; }
    .animate-spark-burst { animation: spark-burst ease-out forwards; }
    .animate-spark-spiral { animation: spark-spiral linear forwards; }
    .animate-breathe { animation: breathe 4s var(--ease-in-out-sine) infinite; }
    .animate-score-pop { animation: score-pop 0.4s var(--ease-out-expo); }

    /* Staggered animations */
    .stagger-1 { animation-delay: 0.1s; opacity: 0; }
    .stagger-2 { animation-delay: 0.2s; opacity: 0; }
    .stagger-3 { animation-delay: 0.3s; opacity: 0; }
    .stagger-4 { animation-delay: 0.4s; opacity: 0; }
    .stagger-5 { animation-delay: 0.5s; opacity: 0; }

    /* Scrollbar */
    textarea::-webkit-scrollbar, div::-webkit-scrollbar { width: 0px; }
    textarea::placeholder { opacity: 0.15; letter-spacing: 0.1em; }

    /* Selection colors */
    .selection-warm::selection { background: rgba(180, 120, 80, 0.25); }
    .selection-cool::selection { background: rgba(140, 160, 200, 0.25); }

    /* Spark text highlights */
    .spark-text-warm { 
      background: linear-gradient(135deg, rgba(240, 200, 140, 0.5), rgba(230, 180, 120, 0.35));
      border-radius: 3px; 
      padding: 1px 4px; 
      margin: 0 -2px; 
      color: rgb(120, 70, 30); 
      box-shadow: 0 2px 12px rgba(180, 120, 60, 0.25);
      transition: all 1.2s var(--ease-out-expo); 
    }
    .spark-text-cool { 
      color: rgb(180, 200, 240); 
      text-shadow: 0 0 20px rgba(140, 180, 255, 0.6), 0 0 40px rgba(140, 180, 255, 0.3);
      transition: all 1.2s var(--ease-out-expo); 
    }

    /* Gradient text */
    .gradient-text {
      background: linear-gradient(135deg, currentColor 0%, currentColor 100%);
      -webkit-background-clip: text;
      background-clip: text;
    }

    /* Glass morphism */
    .glass {
      backdrop-filter: blur(20px) saturate(180%);
      -webkit-backdrop-filter: blur(20px) saturate(180%);
    }

    /* Dropdown */
    .dropdown-menu {
      transform-origin: top right;
      transition: transform 0.25s var(--ease-out-expo), opacity 0.2s ease;
    }
    .dropdown-menu.hidden {
      transform: scaleY(0) scaleX(0.95);
      opacity: 0;
      pointer-events: none;
    }

    /* Flow bar glow */
    .flow-bar-glow {
      transition: all 0.3s ease;
    }

    /* Button hover effects */
    .btn-primary {
      position: relative;
      overflow: hidden;
    }
    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0; left: -100%; 
      width: 100%; height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    .btn-primary:hover::before {
      left: 100%;
    }

    /* Decorative elements */
    .corner-flourish {
      position: absolute;
      width: 60px;
      height: 60px;
      opacity: 0.08;
      pointer-events: none;
    }
    .corner-flourish svg {
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body class="noise-bg">
  <div id="app"></div>

  <script>
    // ===== CONSTANTS =====
    const CONSTANTS = {
      COMBO_THRESHOLD: 15,
      SPARK_COUNT: 45,
      HISTORY_LIMIT: 50,
      COMBO_TIMEOUT_MS: 1200,
      SPARK_DURATION_MS: 6000,
      SPARK_WORD_HIGHLIGHT_MS: 5000,
      MIN_SPARK_INTERVAL: 15,
      MAX_SPARK_INTERVAL: 50,
      SCORE_UPDATE_INTERVAL_MS: 5000,
    };

    const DIFFICULTIES = {
      Novice: { drainRate: 1.0, gainRate: 1.6, label: "Gentle pace", icon: "◦" },
      Writer: { drainRate: 1.3, gainRate: 1.7, label: "Steady flow", icon: "◦◦" },
      Adept: { drainRate: 1.7, gainRate: 1.8, label: "Sharp focus", icon: "◦◦◦" },
      Master: { drainRate: 2.2, gainRate: 1.9, label: "Pure presence", icon: "◦◦◦◦" }
    };

    const THEMES = {
      warm: {
        name: 'Skeleton Pink',
        bg: "#0a0a0a",
        bgGradient: "linear-gradient(165deg, #0a0a0a 0%, #121212 50%, #0d0d0d 100%)",
        text: "#ffffff",
        textMuted: "rgba(255, 255, 255, 0.6)",
        card: "rgba(20, 20, 20, 0.92)",
        cardSolid: "#141414",
        accent: "#fd19c8",
        accentLight: "rgba(253, 25, 200, 0.15)",
        border: "rgba(253, 25, 200, 0.25)",
        input: "#ffffff",
        bar: "#fd19c8",
        barTrack: "rgba(253, 25, 200, 0.2)",
        sparkColor: "rgba(253, 25, 200, 0.4)",
        glow: "rgba(253, 25, 200, 0.5)"
      },
      cool: {
        name: 'Skeleton Purple',
        bg: "#000000",
        bgGradient: "linear-gradient(165deg, #000000 0%, #0a0a0a 50%, #050505 100%)",
        text: "#ffffff",
        textMuted: "rgba(255, 255, 255, 0.5)",
        card: "rgba(15, 15, 15, 0.9)",
        cardSolid: "#0f0f0f",
        accent: "#da70d6",
        accentLight: "rgba(218, 112, 214, 0.12)",
        border: "rgba(218, 112, 214, 0.2)",
        input: "#ffffff",
        bar: "#da70d6",
        barTrack: "rgba(218, 112, 214, 0.2)",
        sparkColor: "rgba(218, 112, 214, 0.35)",
        glow: "rgba(218, 112, 214, 0.5)"
      }
    };

    // ===== ICONS =====
    const icons = {
      wind: `<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.7 7.7a2.5 2.5 0 1 1 1.8 4.3H2"/><path d="M9.6 4.6A2 2 0 1 1 11 8H2"/><path d="M12.6 19.4A2 2 0 1 0 14 16H2"/></svg>`,
      barChart: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" x2="12" y1="20" y2="10"/><line x1="18" x2="18" y1="20" y2="4"/><line x1="6" x2="6" y1="20" y2="16"/></svg>`,
      moon: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>`,
      sun: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></svg>`,
      sparkles: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M19 17v4"/><path d="M3 5h4"/><path d="M17 19h4"/></svg>`,
      trophy: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>`,
      history: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>`,
      chevronRight: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m9 18 6-6-6-6"/></svg>`,
      chevronDown: `<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m6 9 6 6 6-6"/></svg>`,
      x: `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>`,
      trendingUp: `<svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>`,
      flame: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></svg>`,
      download: `<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>`,
      mail: `<svg xmlns="http://www.w3.org/2000/svg" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>`,
      pause: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="14" y="4" width="4" height="16" rx="1"/><rect x="6" y="4" width="4" height="16" rx="1"/></svg>`,
      play: `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><polygon points="6 3 20 12 6 21 6 3"/></svg>`,
      feather: `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12.67 19a2 2 0 0 0 1.416-.588l6.154-6.172a6 6 0 0 0-8.49-8.49L5.586 9.914A2 2 0 0 0 5 11.328V18a1 1 0 0 0 1 1z"/><path d="M16 8 2 22"/><path d="M17.5 15H9"/></svg>`,
      flourish: `<svg viewBox="0 0 60 60" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M5 55 C 20 55, 55 20, 55 5" stroke="currentColor" stroke-width="1" fill="none"/><path d="M10 55 C 25 50, 50 25, 55 10" stroke="currentColor" stroke-width="0.5" fill="none"/><circle cx="55" cy="5" r="2" fill="currentColor"/></svg>`
    };

    // ===== STATE =====
    const state = {
      theme: 'warm',
      difficulty: 'Writer',
      gameState: 'idle',
      showStats: false,
      showMobileMenu: false,
      text: '',
      flow: 100,
      targetFlow: 100,
      score: 0,
      displayScore: 0,
      totalTime: 0,
      combo: 0,
      wordCount: 0,
      nextSparkAt: getNextSparkInterval(),
      sparks: [],
      sparkedWords: {},
      history: [],
      streak: { current: 0, lastDate: null },
      _highScoresCache: null,
      _highScoresCacheKey: null,
    };

    // ===== TIMERS & REFS =====
    let lastUpdate = null;
    let lastScoreUpdate = 0;
    let animationId = null;
    let comboTimeout = null;
    let sparkTimeouts = [];

    // ===== DOM CACHE =====
    const dom = {};

    // ===== HELPERS =====
    function getNextSparkInterval() {
      return Math.floor(Math.random() * (CONSTANTS.MAX_SPARK_INTERVAL - CONSTANTS.MIN_SPARK_INTERVAL + 1) + CONSTANTS.MIN_SPARK_INTERVAL);
    }

    function generateSparks(count) {
      const types = ['float', 'twinkle', 'burst', 'spiral'];
      const shapes = ['circle', 'star', 'diamond'];
      
      return Array.from({ length: count }).map((_, i) => {
        const type = types[Math.floor(Math.random() * types.length)];
        const shape = shapes[Math.floor(Math.random() * shapes.length)];
        const isCenterBurst = i < 8; // First 8 sparks burst from center
        
        return {
          id: Math.random(),
          type,
          shape,
          left: isCenterBurst ? 45 + Math.random() * 10 : Math.random() * 100,
          top: isCenterBurst ? 40 + Math.random() * 10 : 10 + Math.random() * 60,
          size: type === 'twinkle' ? Math.random() * 6 + 2 : Math.random() * 14 + 5,
          delay: isCenterBurst ? Math.random() * 0.3 : Math.random() * 2,
          duration: type === 'twinkle' ? Math.random() * 2 + 1.5 : Math.random() * 3 + 2.5,
          drift: (Math.random() - 0.5) * (isCenterBurst ? 200 : 100),
          rise: isCenterBurst ? -(Math.random() * 150 + 50) : -140,
          rotation: Math.random() * 360,
          hueShift: Math.random() * 30 - 15 // Slight color variation
        };
      });
    }

    function getHighScores() {
      const cacheKey = state.history.length + '-' + (state.history[0]?.id || 0);
      if (state._highScoresCacheKey === cacheKey) {
        return state._highScoresCache;
      }
      state._highScoresCache = [...state.history].sort((a, b) => b.score - a.score).slice(0, 5);
      state._highScoresCacheKey = cacheKey;
      return state._highScoresCache;
    }

    function loadFromStorage() {
      try {
        const saved = localStorage.getItem('flowstate_history_v13');
        state.history = saved ? JSON.parse(saved) : [];
        
        const streakData = localStorage.getItem('flowstate_streak_v13');
        if (streakData) state.streak = JSON.parse(streakData);
        
        const prefs = localStorage.getItem('flowstate_prefs_v13');
        if (prefs) {
          const { theme, difficulty } = JSON.parse(prefs);
          if (theme) state.theme = theme;
          if (difficulty) state.difficulty = difficulty;
        }
      } catch (e) {
        console.warn('LocalStorage unavailable:', e);
      }
    }

    function saveHistory() {
      try { localStorage.setItem('flowstate_history_v13', JSON.stringify(state.history)); } catch (e) {}
    }

    function saveStreak() {
      try { localStorage.setItem('flowstate_streak_v13', JSON.stringify(state.streak)); } catch (e) {}
    }

    function savePrefs() {
      try { localStorage.setItem('flowstate_prefs_v13', JSON.stringify({ theme: state.theme, difficulty: state.difficulty })); } catch (e) {}
    }

    function updateStreak() {
      const today = new Date().toDateString();
      if (state.streak.lastDate === today) return;
      
      const yesterday = new Date(Date.now() - 86400000).toDateString();
      state.streak.current = (state.streak.lastDate === yesterday) ? state.streak.current + 1 : 1;
      state.streak.lastDate = today;
      saveStreak();
    }

    function formatTime(seconds) {
      const m = Math.floor(seconds / 60);
      const s = Math.floor(seconds % 60);
      return m === 0 ? `${s}s` : `${m}m ${s}s`;
    }

    function escapeHtml(str) {
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    // ===== EXPORT FUNCTIONS =====
    function exportText(format = 'txt') {
      if (!state.text.trim()) return;
      
      const filename = `flowstate-${new Date().toISOString().slice(0,10)}.${format}`;
      let content = state.text;
      
      if (format === 'md') {
        content = `# WitherNaught Session\n\n*${new Date().toLocaleDateString()} • ${state.wordCount} words • ${formatTime(state.totalTime)}*\n\n---\n\n${state.text}`;
      }
      
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      a.click();
      URL.revokeObjectURL(url);
    }

    function exportToGmail() {
      if (!state.text.trim()) return;
      
      const subject = encodeURIComponent(`WitherNaught Session - ${new Date().toLocaleDateString()}`);
      const wpm = Math.floor((state.wordCount / (state.totalTime / 60)) || 0);
      const stats = `[${state.wordCount} words • ${formatTime(state.totalTime)} • ${wpm} WPM • Score: ${Math.floor(state.score).toLocaleString()}]`;
      const body = encodeURIComponent(`${state.text}\n\n---\n${stats}\nWritten in WitherNaught`);
      
      window.open(`https://mail.google.com/mail/?view=cm&fs=1&su=${subject}&body=${body}`, '_blank');
    }

    // ===== RENDER HELPERS =====
    function renderHighlightedText() {
      if (!state.text) return '';
      const words = state.text.split(/(\s+)/);
      let wordIndexCount = 0;
      return words.map((part) => {
        if (/\s+/.test(part)) return part;
        const currentIndex = wordIndexCount++;
        const isSparkActive = state.sparkedWords[currentIndex];
        return `<span class="${isSparkActive ? `spark-text-${state.theme}` : 'transition-all duration-1000'}">${escapeHtml(part)}</span>`;
      }).join('');
    }

    function renderSparks(t) {
      return state.sparks.map(spark => {
        const animClass = `animate-spark-${spark.type}`;
        
        // Create different shapes
        let shapeStyle = '';
        let innerContent = '';
        
        if (spark.shape === 'star') {
          innerContent = `<svg viewBox="0 0 24 24" fill="${t.sparkColor}" style="width: 100%; height: 100%; filter: drop-shadow(0 0 ${spark.size}px ${t.glow});">
            <path d="M12 2l2.4 7.4H22l-6 4.6 2.3 7L12 17l-6.3 4 2.3-7-6-4.6h7.6z"/>
          </svg>`;
        } else if (spark.shape === 'diamond') {
          shapeStyle = `transform: rotate(45deg); border-radius: 3px;`;
        } else {
          shapeStyle = `border-radius: 50%;`;
        }
        
        const glowIntensity = spark.type === 'burst' ? 3 : 2;
        const baseColor = t.sparkColor;
        const glowColor = t.glow;
        
        return `
          <div class="absolute ${animClass}"
            style="left: ${spark.left}%; top: ${spark.top}%; width: ${spark.size}px; height: ${spark.size}px; 
            ${spark.shape !== 'star' ? `background: radial-gradient(circle, ${baseColor} 0%, ${baseColor.replace('0.3', '0.1')} 50%, transparent 70%);` : ''}
            ${shapeStyle}
            box-shadow: 0 0 ${spark.size * glowIntensity}px ${glowColor}, 0 0 ${spark.size * glowIntensity * 2}px ${baseColor}; 
            animation-delay: ${spark.delay}s; 
            animation-duration: ${spark.duration}s; 
            --drift: ${spark.drift}px;
            --rise: ${spark.rise}px;
            --glow-color: ${glowColor};">
            ${innerContent}
          </div>
        `;
      }).join('');
    }

    function renderEndScreen(t) {
      const highScores = getHighScores();
      const wpm = Math.floor((state.wordCount / (state.totalTime / 60)) || 0);
      const isNewBest = state.score >= (highScores[0]?.score || 0) && state.history.length > 1;
      
      return `
        <div class="absolute inset-0 z-40 flex items-center justify-center rounded-2xl glass" style="background: ${t.card};">
          <div class="w-full max-w-md p-10 md:p-12 relative">
            
            <!-- Decorative corners -->
            <div class="corner-flourish top-0 left-0" style="color: ${t.text};">${icons.flourish}</div>
            <div class="corner-flourish top-0 right-0 rotate-90" style="color: ${t.text};">${icons.flourish}</div>
            
            <div class="animate-slide-up stagger-1">
              <div class="flex justify-between items-start mb-8">
                <div>
                  <h2 class="text-3xl font-light tracking-tight mb-1">Session Complete</h2>
                  <p class="text-xs uppercase tracking-[0.25em] opacity-40 font-sans">Your words have been captured</p>
                </div>
                ${isNewBest ? `
                  <div class="flex items-center gap-2 px-4 py-2 rounded-full text-xs font-sans font-medium uppercase tracking-wider animate-float" style="background: ${t.accentLight}; color: ${t.accent};">
                    ${icons.trophy} Personal Best
                  </div>
                ` : ''}
              </div>
            </div>

            ${state.streak.current > 1 ? `
              <div class="animate-slide-up stagger-2 mb-8 flex items-center gap-3" style="color: ${t.accent};">
                <span class="animate-float">${icons.flame}</span>
                <span class="text-lg font-light">${state.streak.current} day streak</span>
              </div>
            ` : ''}

            <div class="animate-slide-up stagger-2 grid grid-cols-3 gap-6 mb-10 py-8 border-y" style="border-color: ${t.border};">
              <div class="text-center">
                <div class="text-3xl font-light mb-1">${Math.floor(state.score).toLocaleString()}</div>
                <div class="text-[10px] uppercase tracking-[0.2em] opacity-40 font-sans">Score</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-light mb-1">${state.wordCount}</div>
                <div class="text-[10px] uppercase tracking-[0.2em] opacity-40 font-sans">Words</div>
              </div>
              <div class="text-center">
                <div class="text-3xl font-light mb-1">${wpm}</div>
                <div class="text-[10px] uppercase tracking-[0.2em] opacity-40 font-sans">WPM</div>
              </div>
            </div>

            <div class="animate-slide-up stagger-3 mb-10 p-5 rounded-2xl" style="background: ${t.accentLight};">
              <h3 class="text-[10px] uppercase tracking-[0.25em] opacity-50 mb-4 flex items-center gap-2 font-sans">
                ${icons.history} Hall of Fame
              </h3>
              <div class="space-y-3">
                ${highScores.length > 0 ? highScores.map((hs, idx) => `
                  <div class="flex justify-between items-center text-sm opacity-80">
                    <span class="flex items-center gap-3">
                      <span class="w-5 h-5 rounded-full flex items-center justify-center text-[10px] font-sans" style="background: ${t.border};">${idx + 1}</span>
                      ${new Date(hs.date).toLocaleDateString()}
                    </span>
                    <span class="font-sans font-medium">${hs.score.toLocaleString()}</span>
                  </div>
                `).join('') : `
                  <div class="text-sm opacity-40 italic text-center py-3">
                    Your journey begins here
                  </div>
                `}
              </div>
            </div>
            
            <div class="animate-slide-up stagger-4 space-y-4">
              <button onclick="WitherNaught.startNextRound(true)" class="btn-primary w-full flex items-center justify-center gap-3 px-8 py-4 rounded-2xl text-white font-sans text-xs tracking-[0.2em] uppercase transition-all hover:scale-[1.02] active:scale-[0.98]" style="background: ${t.accent}; box-shadow: 0 8px 32px ${t.glow};">
                ${icons.chevronRight} Continue Writing
              </button>
              
              <div class="grid grid-cols-3 gap-3">
                <button onclick="WitherNaught.exportText('txt')" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl border text-[10px] uppercase tracking-wider font-sans opacity-60 hover:opacity-100 transition-all hover:scale-[1.02]" style="border-color: ${t.border};">
                  ${icons.download}
                  <span class="hidden sm:inline">Save</span>
                </button>
                <button onclick="WitherNaught.exportToGmail()" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl border text-[10px] uppercase tracking-wider font-sans opacity-60 hover:opacity-100 transition-all hover:scale-[1.02]" style="border-color: ${t.border};">
                  ${icons.mail}
                  <span class="hidden sm:inline">Gmail</span>
                </button>
                <button onclick="WitherNaught.startNextRound(false)" class="flex items-center justify-center gap-2 px-4 py-3 rounded-xl border text-[10px] uppercase tracking-wider font-sans opacity-60 hover:opacity-100 transition-all hover:scale-[1.02]" style="border-color: ${t.border};">
                  Fresh
                </button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderStatsOverlay(t) {
      const chartData = [...state.history].reverse().slice(-10);
      const maxScore = Math.max(...chartData.map(d => d.score), 1);
      const maxWords = Math.max(...chartData.map(d => d.words), 1);
      const totalWords = state.history.reduce((acc, curr) => acc + curr.words, 0);
      const totalTimeMinutes = Math.floor(state.history.reduce((acc, curr) => acc + curr.time, 0) / 60);
      const avgWpm = state.history.length > 0 ? Math.floor(state.history.reduce((acc, curr) => acc + curr.wpm, 0) / state.history.length) : 0;

      return `
        <div class="absolute inset-0 z-50 flex items-center justify-center rounded-2xl glass" style="background: ${t.card};">
          <div class="w-full h-full p-8 md:p-12 overflow-y-auto relative">
            <button onclick="WitherNaught.closeStats()" class="absolute top-6 right-6 md:top-8 md:right-8 p-3 rounded-full opacity-40 hover:opacity-100 transition-all hover:rotate-90" style="background: ${t.accentLight};">
              ${icons.x}
            </button>
            
            <div class="max-w-xl mx-auto">
              <div class="animate-slide-up stagger-1">
                <div class="flex items-center justify-between mb-2">
                  <h2 class="text-4xl font-light tracking-tight">Your Journey</h2>
                  ${state.streak.current > 0 ? `
                    <div class="flex items-center gap-2" style="color: ${t.accent};">
                      ${icons.flame}
                      <span class="text-xl font-sans font-bold">${state.streak.current}</span>
                    </div>
                  ` : ''}
                </div>
                <p class="text-xs uppercase tracking-[0.3em] opacity-40 mb-12 font-sans">Progress & Analytics</p>
              </div>

              <div class="space-y-12">
                <section class="animate-slide-up stagger-2">
                  <h3 class="text-[10px] uppercase tracking-[0.25em] opacity-50 mb-6 flex items-center gap-2 font-sans">
                    ${icons.trendingUp} Score Progression
                  </h3>
                  <div class="flex items-end justify-between h-32 gap-2 pt-4 pb-2 border-b" style="border-color: ${t.border};">
                    ${chartData.length > 0 ? chartData.map((d, i) => `
                      <div class="w-full rounded-t transition-all duration-500 hover:opacity-100 cursor-default group relative" 
                        style="height: ${Math.max(4, (d.score / maxScore) * 100)}%; background: linear-gradient(to top, ${t.accent}, ${t.accent}88); opacity: ${0.4 + (i / 10) * 0.6};">
                        <div class="absolute -top-8 left-1/2 -translate-x-1/2 px-2 py-1 rounded text-[9px] font-sans opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap" style="background: ${t.cardSolid}; color: ${t.text};">
                          ${d.score.toLocaleString()}
                        </div>
                      </div>
                    `).join('') : '<div class="w-full text-center text-sm opacity-30 pb-8 italic">Begin your journey</div>'}
                  </div>
                </section>

                <section class="animate-slide-up stagger-3">
                  <h3 class="text-[10px] uppercase tracking-[0.25em] opacity-50 mb-6 font-sans">Word Volume</h3>
                  <div class="flex items-end justify-between h-24 gap-2 pt-4 pb-2 border-b" style="border-color: ${t.border};">
                    ${chartData.length > 0 ? chartData.map((d, i) => `
                      <div class="w-full rounded-t transition-all duration-500" 
                        style="height: ${Math.max(4, (d.words / maxWords) * 100)}%; background: linear-gradient(to top, #10b981, #10b98188); opacity: ${0.4 + (i / 10) * 0.6};"></div>
                    `).join('') : ''}
                  </div>
                </section>

                <div class="animate-slide-up stagger-4 grid grid-cols-3 gap-8 py-8 border-y" style="border-color: ${t.border};">
                  <div>
                    <div class="text-[10px] uppercase tracking-[0.2em] opacity-30 mb-2 font-sans">Total Words</div>
                    <div class="text-3xl font-light">${totalWords.toLocaleString()}</div>
                  </div>
                  <div>
                    <div class="text-[10px] uppercase tracking-[0.2em] opacity-30 mb-2 font-sans">Time Spent</div>
                    <div class="text-3xl font-light">${totalTimeMinutes}m</div>
                  </div>
                  <div>
                    <div class="text-[10px] uppercase tracking-[0.2em] opacity-30 mb-2 font-sans">Avg WPM</div>
                    <div class="text-3xl font-light">${avgWpm}</div>
                  </div>
                </div>

                <div class="animate-slide-up stagger-5 pt-4">
                  <h3 class="text-[10px] uppercase tracking-[0.25em] opacity-50 mb-6 font-sans">Recent Sessions</h3>
                  <div class="space-y-4">
                    ${state.history.slice(0, 6).map(h => `
                      <div class="flex justify-between items-center py-3 border-b opacity-70 hover:opacity-100 transition-opacity" style="border-color: ${t.border};">
                        <div>
                          <div class="text-sm font-sans">${new Date(h.date).toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}</div>
                          <div class="text-[10px] uppercase tracking-widest opacity-40 font-sans">${h.difficulty}</div>
                        </div>
                        <div class="text-right">
                          <div class="text-sm font-sans font-medium">${h.score.toLocaleString()}</div>
                          <div class="text-[10px] opacity-40 font-sans">${h.words}w • ${h.wpm}wpm</div>
                        </div>
                      </div>
                    `).join('')}
                    ${state.history.length === 0 ? `
                      <div class="text-center py-12 opacity-30 italic">
                        Your story awaits
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function renderPauseOverlay(t) {
      return `
        <div class="absolute inset-0 z-40 flex items-center justify-center rounded-2xl glass" style="background: ${t.card};">
          <div class="text-center animate-scale-in">
            <div class="w-20 h-20 mx-auto mb-6 rounded-full flex items-center justify-center animate-breathe" style="background: ${t.accentLight}; color: ${t.accent};">
              ${icons.pause}
            </div>
            <h2 class="text-3xl font-light tracking-tight mb-2">Paused</h2>
            <p class="text-xs uppercase tracking-[0.25em] opacity-40 mb-10 font-sans">Take a breath</p>
            <button onclick="WitherNaught.togglePause()" class="btn-primary px-10 py-4 rounded-2xl text-white font-sans text-xs tracking-[0.2em] uppercase transition-all hover:scale-105" style="background: ${t.accent}; box-shadow: 0 8px 32px ${t.glow};">
              ${icons.play} Resume Flow
            </button>
          </div>
        </div>
      `;
    }

    // ===== MAIN RENDER =====
    function render() {
      const t = THEMES[state.theme];
      document.body.style.background = t.bgGradient;
      
      const app = document.getElementById('app');
      app.innerHTML = `
        <div class="min-h-screen transition-colors duration-1000 selection-${state.theme} flex flex-col items-center p-6 md:p-12 lg:p-16 overflow-hidden relative" style="color: ${t.text};">
          
          <!-- Ambient background glow -->
          <div class="fixed top-0 left-1/2 -translate-x-1/2 w-[800px] h-[600px] pointer-events-none opacity-30 animate-breathe" 
            style="background: radial-gradient(ellipse at center, ${t.sparkColor} 0%, transparent 70%); filter: blur(60px);">
          </div>

          <!-- Spark particles -->
          <div id="sparks-container" class="fixed top-0 left-0 w-full h-[50vh] pointer-events-none z-0 overflow-hidden" 
            style="mask-image: linear-gradient(to bottom, black 30%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 30%, transparent 100%);">
            ${renderSparks(t)}
          </div>

          <header class="w-full max-w-4xl flex justify-between items-center mb-12 md:mb-20 z-20 animate-fade-in">
            <div class="flex items-center gap-4 cursor-default group">
              <div class="p-2 rounded-xl transition-all duration-500 group-hover:scale-110" style="color: ${t.accent}; background: ${t.accentLight};">
                ${icons.feather}
              </div>
              <div>
                <h1 class="text-lg md:text-xl font-light tracking-[0.3em] uppercase">WitherNaught</h1>
                <p class="text-[9px] tracking-[0.2em] uppercase opacity-40 font-sans hidden md:block">${DIFFICULTIES[state.difficulty].label}</p>
              </div>
            </div>
            
            <div class="flex gap-2 md:gap-4 items-center">
              <!-- Streak -->
              ${state.streak.current > 0 ? `
                <div class="hidden md:flex items-center gap-2 px-3 py-1.5 rounded-full" style="background: ${t.accentLight}; color: ${t.accent};">
                  ${icons.flame}
                  <span class="text-sm font-sans font-bold">${state.streak.current}</span>
                </div>
              ` : ''}

              <!-- Stats -->
              <button onclick="WitherNaught.openStats()" class="p-2.5 rounded-xl opacity-50 hover:opacity-100 transition-all hover:scale-105" style="background: ${t.accentLight};" title="View stats">
                ${icons.barChart}
              </button>

              <!-- Pause -->
              ${state.gameState === 'writing' ? `
                <button onclick="WitherNaught.togglePause()" class="p-2.5 rounded-xl opacity-50 hover:opacity-100 transition-all hover:scale-105" style="background: ${t.accentLight};" title="Pause">
                  ${icons.pause}
                </button>
              ` : ''}

              <!-- Desktop difficulty -->
              <div class="hidden md:flex gap-1 p-1 rounded-xl" style="background: ${t.accentLight};">
                ${Object.entries(DIFFICULTIES).map(([d, config]) => `
                  <button 
                    onclick="WitherNaught.setDifficulty('${d}')"
                    ${state.gameState === 'writing' || state.gameState === 'paused' ? 'disabled' : ''}
                    class="px-3 py-1.5 rounded-lg text-[10px] tracking-wider uppercase font-sans transition-all ${state.difficulty === d ? '' : 'opacity-40 hover:opacity-70'} ${state.gameState === 'writing' ? 'cursor-not-allowed' : ''}"
                    style="${state.difficulty === d ? `background: ${t.cardSolid}; color: ${t.accent}; box-shadow: 0 2px 8px ${t.glow};` : ''}"
                    title="${config.label}">
                    ${d}
                  </button>
                `).join('')}
              </div>

              <!-- Mobile difficulty -->
              <div class="relative md:hidden">
                <button onclick="WitherNaught.toggleMobileMenu()" 
                  class="flex items-center gap-2 px-3 py-2 rounded-xl text-[10px] tracking-wider uppercase font-sans transition-all"
                  style="background: ${t.accentLight};"
                  ${state.gameState === 'writing' || state.gameState === 'paused' ? 'disabled' : ''}>
                  ${state.difficulty}
                  ${icons.chevronDown}
                </button>
                <div class="dropdown-menu absolute right-0 top-full mt-2 py-2 rounded-xl shadow-2xl border z-50 min-w-[140px] ${state.showMobileMenu ? '' : 'hidden'}" 
                  style="background: ${t.cardSolid}; border-color: ${t.border};">
                  ${Object.entries(DIFFICULTIES).map(([d, config]) => `
                    <button onclick="WitherNaught.setDifficulty('${d}')" 
                      class="w-full text-left px-4 py-2.5 text-[11px] tracking-wider uppercase font-sans transition-all ${state.difficulty === d ? 'opacity-100' : 'opacity-50 hover:opacity-80'}"
                      style="${state.difficulty === d ? `color: ${t.accent}; background: ${t.accentLight};` : ''}">
                      ${d}
                      <span class="block text-[9px] opacity-50 normal-case tracking-normal mt-0.5">${config.label}</span>
                    </button>
                  `).join('')}
                </div>
              </div>

              <!-- Theme -->
              <button onclick="WitherNaught.toggleTheme()" class="p-2.5 rounded-xl opacity-50 hover:opacity-100 transition-all hover:scale-105 hover:rotate-12" style="background: ${t.accentLight};" title="Toggle theme">
                ${state.theme === 'warm' ? icons.moon : icons.sun}
              </button>
            </div>
          </header>

          <main class="w-full max-w-3xl flex-grow flex flex-col relative z-10 animate-slide-up" style="animation-delay: 0.2s; opacity: 0;">
            
            <!-- Flow bar -->
            <div class="mb-8 relative">
              <div class="h-1 rounded-full overflow-hidden" style="background: ${t.barTrack};">
                <div id="flow-bar" class="h-full rounded-full" 
                  style="width: ${state.flow}%; background: linear-gradient(90deg, ${t.bar}, ${t.bar}dd); 
                  transition: box-shadow 0.3s ease;
                  box-shadow: ${state.flow < 30 ? `0 0 20px ${t.glow}, 0 0 40px ${t.glow}` : (state.sparks.length > 0 ? `0 0 30px ${t.sparkColor}` : 'none')};">
                </div>
              </div>
              ${state.flow < 30 ? `
                <div class="absolute inset-0 rounded-full animate-pulse" style="box-shadow: 0 0 20px ${t.glow};"></div>
              ` : ''}
            </div>

            <!-- Score & Time display -->
            <div class="flex justify-between items-end mb-10 px-1">
              <div class="flex items-baseline gap-4">
                <div id="score-display" class="text-4xl md:text-5xl font-light tracking-tight tabular-nums transition-all duration-300">${state.displayScore.toLocaleString()}</div>
                <div id="combo-display" class="text-[10px] font-sans tracking-widest uppercase transition-all duration-500 flex items-center gap-2" 
                  style="opacity: ${state.sparks.length > 0 ? 1 : (state.combo > 10 ? 0.4 : 0)}; transform: translateY(${state.sparks.length > 0 ? '-4px' : '0'});">
                  ${state.sparks.length > 0 ? `<span style="color: ${t.accent};">${icons.sparkles}</span> Spark!` : `${Math.floor(state.combo / CONSTANTS.COMBO_THRESHOLD) + 1}× flow`}
                </div>
              </div>
              <div id="time-display" class="text-sm tracking-widest opacity-40 font-sans tabular-nums">${formatTime(state.totalTime)}</div>
            </div>

            <!-- Writing area -->
            <div class="relative flex-grow rounded-2xl" style="min-height: 420px;">
              ${state.gameState === 'ended' ? renderEndScreen(t) : ''}
              ${state.gameState === 'paused' ? renderPauseOverlay(t) : ''}
              ${state.showStats ? renderStatsOverlay(t) : ''}

              <!-- Text overlay for highlights -->
              <div id="text-overlay" class="absolute inset-0 z-0 pointer-events-none whitespace-pre-wrap break-words text-xl md:text-2xl lg:text-[1.65rem] leading-[2] font-light p-1 overflow-y-auto transition-opacity duration-700 ${(state.gameState === 'ended' || state.gameState === 'paused' || state.showStats) ? 'opacity-5' : 'opacity-100'}" style="color: transparent;">
                ${renderHighlightedText()}
              </div>

              <!-- Main textarea -->
              <textarea
                id="main-textarea"
                ${state.gameState === 'ended' || state.gameState === 'paused' || state.showStats ? 'disabled' : ''}
                spellcheck="false"
                placeholder="${state.gameState === 'idle' ? 'Begin writing to enter the flow...' : ''}"
                class="absolute inset-0 w-full h-full z-10 resize-none focus:outline-none text-xl md:text-2xl lg:text-[1.65rem] leading-[2] font-light p-1 overflow-y-auto transition-all duration-700 ${(state.gameState === 'ended' || state.gameState === 'paused' || state.showStats) ? 'opacity-5 blur-xl scale-[0.99]' : 'opacity-100'}"
                style="background: transparent; color: ${t.input}; -webkit-text-fill-color: currentColor; caret-color: ${t.accent};"
              >${state.text}</textarea>
            </div>
          </main>

          <footer class="mt-auto pt-10 flex flex-col items-center gap-3 z-10 animate-fade-in" style="animation-delay: 0.4s; opacity: 0;">
            <div class="w-12 h-px rounded-full" style="background: ${t.border};"></div>
            <p class="font-sans text-[9px] tracking-[0.4em] uppercase opacity-20">
              WitherNaught v13
            </p>
          </footer>
        </div>
      `;

      cacheDomRefs();
      attachEventListeners();
    }

    function cacheDomRefs() {
      dom.textarea = document.getElementById('main-textarea');
      dom.overlay = document.getElementById('text-overlay');
      dom.flowBar = document.getElementById('flow-bar');
      dom.scoreDisplay = document.getElementById('score-display');
      dom.timeDisplay = document.getElementById('time-display');
      dom.comboDisplay = document.getElementById('combo-display');
      dom.sparksContainer = document.getElementById('sparks-container');
    }

    function attachEventListeners() {
      if (dom.textarea) {
        dom.textarea.addEventListener('input', handleTextInput);
        dom.textarea.addEventListener('scroll', handleScroll);
        
        if (state.gameState !== 'ended' && state.gameState !== 'paused' && !state.showStats) {
          dom.textarea.focus();
          const len = state.text.length;
          dom.textarea.setSelectionRange(len, len);
        }
      }

      document.addEventListener('click', (e) => {
        if (state.showMobileMenu && !e.target.closest('.relative.md\\:hidden')) {
          state.showMobileMenu = false;
          render();
        }
      });
    }

    // ===== EVENT HANDLERS =====
    function handleTextInput(e) {
      if (state.gameState === 'ended' || state.gameState === 'paused') return;
      
      const newText = e.target.value;
      const isAdding = newText.length > state.text.length;

      if (state.gameState === 'idle' && newText.length > 0) {
        state.gameState = 'writing';
        state.targetFlow = 100;
        state.flow = 100;
        updateStreak();
      }

      if (isAdding) {
        state.targetFlow = Math.min(100, state.targetFlow + DIFFICULTIES[state.difficulty].gainRate);
        state.combo++;

        const wordsArray = newText.trim().split(/\s+/).filter(w => w.length > 0);
        const currentWordCount = wordsArray.length;

        if (currentWordCount > state.wordCount) {
          state.wordCount = currentWordCount;
          if (currentWordCount >= state.nextSparkAt) {
            triggerSpark(currentWordCount);
          }
        }

        if (comboTimeout) clearTimeout(comboTimeout);
        comboTimeout = setTimeout(() => { state.combo = 0; }, CONSTANTS.COMBO_TIMEOUT_MS);
      }

      state.text = newText;
      
      if (dom.overlay) {
        dom.overlay.innerHTML = renderHighlightedText();
      }
    }

    function triggerSpark(currentWordCount) {
      state.targetFlow = Math.min(100, state.targetFlow + 40);
      state.score += 500;

      const targetIndex = currentWordCount - 1;
      state.sparkedWords[targetIndex] = true;
      
      const highlightTimeout = setTimeout(() => {
        state.sparkedWords[targetIndex] = false;
        if (dom.overlay) dom.overlay.innerHTML = renderHighlightedText();
      }, CONSTANTS.SPARK_WORD_HIGHLIGHT_MS);
      sparkTimeouts.push(highlightTimeout);

      state.nextSparkAt = currentWordCount + getNextSparkInterval();
      state.sparks = generateSparks(CONSTANTS.SPARK_COUNT);
      
      if (dom.sparksContainer) {
        dom.sparksContainer.innerHTML = renderSparks(THEMES[state.theme]);
      }
      
      const sparkClearTimeout = setTimeout(() => {
        state.sparks = [];
        if (dom.sparksContainer) dom.sparksContainer.innerHTML = '';
      }, CONSTANTS.SPARK_DURATION_MS);
      sparkTimeouts.push(sparkClearTimeout);
    }

    function handleScroll() {
      if (dom.overlay && dom.textarea) {
        dom.overlay.scrollTop = dom.textarea.scrollTop;
      }
    }

    function handleGameOver() {
      state.gameState = 'ended';
      state.displayScore = Math.floor(state.score); // Final update
      const finalWords = state.text.trim().split(/\s+/).filter(w => w.length > 0).length;
      const session = {
        id: Date.now(),
        date: new Date().toISOString(),
        score: Math.floor(state.score),
        words: finalWords,
        time: Math.floor(state.totalTime),
        wpm: Math.floor((finalWords / (state.totalTime / 60)) || 0),
        difficulty: state.difficulty
      };
      state.history = [session, ...state.history].slice(0, CONSTANTS.HISTORY_LIMIT);
      state._highScoresCache = null;
      saveHistory();
      render();
    }

    // ===== ANIMATION LOOP =====
    function animate(time) {
      if (lastUpdate !== null && state.gameState === 'writing') {
        const deltaTime = (time - lastUpdate) / 1000;

        const drain = DIFFICULTIES[state.difficulty].drainRate * deltaTime * 10;
        state.targetFlow = Math.max(0, state.targetFlow - drain);

        // When draining: snap directly to target (no lag)
        // When filling: smooth lerp for nice visual feedback
        if (state.targetFlow < state.flow) {
          state.flow = state.targetFlow;
        } else {
          const diff = state.targetFlow - state.flow;
          state.flow = Math.min(100, state.flow + diff * (deltaTime * 10));
        }

        // Game over when flow hits zero
        if (state.flow <= 0) {
          state.flow = 0;
          updateFlowBar();
          handleGameOver();
        } else {
          state.totalTime += deltaTime;
          const multiplier = 1 + (Math.floor(state.combo / CONSTANTS.COMBO_THRESHOLD) * 0.1);
          state.score += deltaTime * 10 * multiplier;

          updateFlowBar();
          updateTimeDisplay();
          
          // Update score display every 5 seconds
          if (time - lastScoreUpdate >= CONSTANTS.SCORE_UPDATE_INTERVAL_MS) {
            updateScoreDisplay();
            lastScoreUpdate = time;
          }
        }
      }
      
      lastUpdate = time;
      animationId = requestAnimationFrame(animate);
    }

    function updateFlowBar() {
      if (!dom.flowBar) return;
      const t = THEMES[state.theme];
      dom.flowBar.style.width = `${state.flow}%`;
      dom.flowBar.style.boxShadow = state.flow < 30 
        ? `0 0 20px ${t.glow}, 0 0 40px ${t.glow}` 
        : (state.sparks.length > 0 ? `0 0 30px ${t.sparkColor}` : 'none');
    }

    function updateScoreDisplay() {
      if (!dom.scoreDisplay) return;
      const newScore = Math.floor(state.score);
      if (newScore !== state.displayScore) {
        state.displayScore = newScore;
        dom.scoreDisplay.textContent = state.displayScore.toLocaleString();
        dom.scoreDisplay.classList.remove('animate-score-pop');
        void dom.scoreDisplay.offsetWidth; // Trigger reflow
        dom.scoreDisplay.classList.add('animate-score-pop');
      }
    }

    function updateTimeDisplay() {
      if (!dom.timeDisplay) return;
      dom.timeDisplay.textContent = formatTime(state.totalTime);
    }

    // ===== CLEANUP =====
    function cleanup() {
      if (animationId) cancelAnimationFrame(animationId);
      if (comboTimeout) clearTimeout(comboTimeout);
      sparkTimeouts.forEach(t => clearTimeout(t));
    }

    window.addEventListener('beforeunload', cleanup);

    // ===== PUBLIC API =====
    window.WitherNaught = {
      startNextRound(preserveText) {
        state.gameState = 'idle';
        if (!preserveText) {
          state.text = '';
          state.wordCount = 0;
          state.sparkedWords = {};
          state.nextSparkAt = getNextSparkInterval();
        }
        state.flow = 100;
        state.targetFlow = 100;
        state.score = 0;
        state.displayScore = 0;
        state.totalTime = 0;
        state.combo = 0;
        state.sparks = [];
        lastScoreUpdate = 0;
        render();
      },

      setDifficulty(d) {
        if (state.gameState !== 'writing' && state.gameState !== 'paused') {
          state.difficulty = d;
          state.showMobileMenu = false;
          savePrefs();
          render();
        }
      },

      toggleTheme() {
        state.theme = state.theme === 'warm' ? 'cool' : 'warm';
        savePrefs();
        render();
      },

      togglePause() {
        if (state.gameState === 'writing') {
          state.gameState = 'paused';
          render();
        } else if (state.gameState === 'paused') {
          state.gameState = 'writing';
          lastUpdate = null;
          render();
        }
      },

      toggleMobileMenu() {
        if (state.gameState !== 'writing' && state.gameState !== 'paused') {
          state.showMobileMenu = !state.showMobileMenu;
          render();
        }
      },

      openStats() {
        state.showStats = true;
        render();
      },

      closeStats() {
        state.showStats = false;
        render();
      },

      exportText,
      exportToGmail
    };

    // ===== INIT =====
    function init() {
      loadFromStorage();
      
      if (!localStorage.getItem('flowstate_prefs_v13')) {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        state.theme = prefersDark ? 'cool' : 'warm';
      }
      
      render();
      animationId = requestAnimationFrame(animate);
    }

    init();
  </script>
</body>
</html>
