<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BeatHive - Story Structure Architect</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><polygon points='50,5 95,27.5 95,72.5 50,95 5,72.5 5,27.5' fill='%23fd19c8'/><polygon points='50,20 80,37.5 80,62.5 50,80 20,62.5 20,37.5' fill='%23da70d6' opacity='0.6'/></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;800&family=Space+Grotesk:wght@700&family=Lora:ital,wght@0,400;0,600;1,400&display=swap');
        
        :root {
            --bg-dark: #000000;
            --bg-light: #1a1a1a;
            --panel-light: #242424;
            --text-light: #ffffff;
            --accent-pink: #fd19c8;
            --accent-purple: #da70d6;
            --accent-yellow: #fae84f;
            --sidebar-width: 320px;
        }

        body {
            font-family: 'Inter', sans-serif;
            overflow: hidden;
            margin: 0;
            padding: 0;
            transition: background-color 0.5s cubic-bezier(0.16, 1, 0.3, 1);
            user-select: none;
            -webkit-user-select: none;
        }

        /* Typography */
        .font-display { font-family: 'Space Grotesk', sans-serif; }
        .font-serif { font-family: 'Lora', serif; }

        /* Theme Classes */
        .light-theme {
            background-color: var(--bg-light) !important;
            color: #ffffff;
        }
        .dark-theme {
            background-color: var(--bg-dark) !important;
            color: #ffffff;
        }

        /* Smooth Sidebar Architecture */
        .sidebar-panel {
            transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            border-color: rgba(255, 255, 255, 0.05);
        }
        
        .light-theme .sidebar-panel {
            border-color: rgba(253, 25, 200, 0.15);
            background: rgba(26, 26, 26, 0.95);
        }
        .dark-theme .sidebar-panel {
            border-color: rgba(253, 25, 200, 0.12);
            background: rgba(10, 10, 10, 0.95);
        }

        .sidebar-inner {
            min-width: var(--sidebar-width);
            width: var(--sidebar-width);
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        /* Hex & Grid */
        .hex-transition { transition: transform 0.1s linear, fill 0.2s ease; }
        .bg-grid-dark { background-image: radial-gradient(rgba(253, 25, 200, 0.08) 1.5px, transparent 1px); background-size: 40px 40px; }
        .bg-grid-light { background-image: radial-gradient(rgba(253, 25, 200, 0.1) 1.5px, transparent 1px); background-size: 40px 40px; }

        .hex-shadow {
            filter: drop-shadow(0 4px 6px rgba(0,0,0,0.15));
            transition: transform 0.15s ease, filter 0.15s ease;
            transform-origin: center center;
            transform-box: fill-box;
        }
        .hex-group:hover .hex-shadow {
            transform: scale(1.015);
            filter: drop-shadow(0 8px 12px rgba(0,0,0,0.18));
        }
        /* Prevent hover jitter by adding invisible hit area */
        .hex-group { isolation: isolate; }

        .tooltip { visibility: hidden; opacity: 0; transition: opacity 0.2s; position: absolute; z-index: 100; bottom: 120%; left: 50%; transform: translateX(-50%); pointer-events: none; }
        .group:hover .tooltip { visibility: visible; opacity: 1; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        textarea, input { user-select: text !important; -webkit-user-select: text !important; }

        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 12px;
            width: 12px;
            border-radius: 50%;
            background: currentColor;
            cursor: pointer;
            margin-top: -4px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: currentColor;
            opacity: 0.2;
            border-radius: 2px;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-in { animation: fadeIn 0.15s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        /* Minimap */
        .minimap {
            position: absolute;
            bottom: 80px;
            right: 20px;
            width: 150px;
            height: 120px;
            border-radius: 12px;
            overflow: hidden;
            z-index: 50;
            opacity: 0.8;
            transition: opacity 0.2s, transform 0.2s;
        }
        .minimap:hover {
            opacity: 1;
            transform: scale(1.05);
        }
        .dark-theme .minimap { background: rgba(0,0,0,0.8); border: 1px solid rgba(253, 25, 200, 0.2); }
        .light-theme .minimap { background: rgba(26,26,26,0.9); border: 1px solid rgba(253, 25, 200, 0.15); }
        .minimap-viewport {
            position: absolute;
            border: 2px solid #fd19c8;
            border-radius: 3px;
            pointer-events: none;
        }
    </style>
</head>
<body class="dark-theme">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        window.FirebaseLib = { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, doc, setDoc, getDoc, getDocs, collection, query, onSnapshot, addDoc, updateDoc, deleteDoc, serverTimestamp };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo, useCallback } = React;

        const HEX_SIZE = 130; 
        const HEX_WIDTH = Math.sqrt(3) * HEX_SIZE;
        const HEX_HEIGHT = 2 * HEX_SIZE;
        const VERT_SPACING = HEX_HEIGHT * 0.75;
        const LOCAL_STORAGE_KEY = 'writingtools_beathive_sketches';

        const Icon = ({ name, size = 20, className = "", style = {} }) => {
            const icons = {
                mask: <path d="M12 2a10 10 0 0 0-10 10c0 5.5 4.5 10 10 10s10-4.5 10-10A10 10 0 0 0 12 2zm-3 9a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm6 0a1 1 0 1 1 0-2 1 1 0 0 1 0 2zm-6 4s1.5 2 3 2 3-2 3-2"/>,
                plus: <path d="M12 5v14M5 12h14"/>,
                trash: (
                    <React.Fragment>
                        <path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </React.Fragment>
                ),
                zoomIn: <g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></g>,
                zoomOut: <g><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></g>,
                sun: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="4"/>
                        <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 17.66l-1.41 1.41M19.07 4.93l-1.41 1.41"/>
                    </React.Fragment>
                ),
                moon: <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/>,
                folder: <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/>,
                chevronLeft: <polyline points="15 18 9 12 15 6" />,
                chevronRight: <polyline points="9 18 15 12 9 6" />,
                zap: <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>,
                repeat: (
                    <React.Fragment>
                        <polyline points="17 1 21 5 17 9"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><polyline points="7 23 3 19 7 15"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/>
                    </React.Fragment>
                ),
                alert: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
                    </React.Fragment>
                ),
                ghost: <path d="M9 10h.01M15 10h.01M12 2a8 8 0 0 0-8 8v12l3-3 2.5 2.5L12 19l2.5 2.5L17 19l3 3V10a8 8 0 0 0-8-8z"/>,
                eyeOff: (
                    <React.Fragment>
                        <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                        <line x1="1" y1="1" x2="23" y2="23"/>
                    </React.Fragment>
                ),
                more: (
                    <React.Fragment>
                        <circle cx="12" cy="12" r="1"/>
                        <circle cx="19" cy="12" r="1"/>
                        <circle cx="5" cy="12" r="1"/>
                    </React.Fragment>
                )
            };
            return (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} style={style}>
                    {icons[name] || <circle cx="12" cy="12" r="10" />}
                </svg>
            );
        };

        const STICKERS = [
            { id: 'game', icon: 'zap', color: '#eab308', label: 'The Game' },
            { id: 'callback', icon: 'repeat', color: '#3b82f6', label: 'Call-back' },
            { id: 'twist', icon: 'alert', color: '#ef4444', label: 'Subversion' },
            { id: 'weird', icon: 'ghost', color: '#a855f7', label: 'Weird Thing' },
            { id: 'secret', icon: 'eyeOff', color: '#6b7280', label: 'Hidden Info' },
        ];

        // Sticker icon component for use in tags
        const StickerIcon = ({ stickerId, size = 14, theme }) => {
            const sticker = STICKERS.find(s => s.id === stickerId);
            if (!sticker) return null;
            return <Icon name={sticker.icon} size={size} style={{ color: sticker.color }} />;
        };

        const BEAT_TYPES = [
            { id: 'setup', label: 'Normal World', color: { dark: '#1e3a8a', light: '#4361ee' }, stroke: { dark: '#3b82f6', light: '#2563eb' } },
            { id: 'inciting', label: 'First Weird Thing', color: { dark: '#581c87', light: '#7209b7' }, stroke: { dark: '#a855f7', light: '#9333ea' } },
            { id: 'heightening', label: 'Heightening', color: { dark: '#14532d', light: '#bbf7d0' }, stroke: { dark: '#22c55e', light: '#16a34a' } },
            { id: 'blowoff', label: 'Ending', color: { dark: '#7f1d1d', light: '#fca5a5' }, stroke: { dark: '#ef4444', light: '#dc2626' } },
            { id: 'note', label: 'Context / Note', color: { dark: '#1e293b', light: '#6c757d' }, stroke: { dark: '#475569', light: '#9ca3af' } },
        ];

        // --- NEW INTEGRATED GUIDE IN MAP HEXES ---
        const WELCOME_CELLS = [
            { q: 0, r: 0, type: 'setup', content: "WELCOME TO BEATHIVE\n\nThis is your infinite narrative canvas. Beats persist automatically.", tags: ['zap'] },
            { q: 0, r: 1, type: 'inciting', content: "NAVIGATION\n\n• WASD to Pan\n• Scroll to Zoom\n• Drag background to slide", tags: [] },
            { q: 0, r: 2, type: 'heightening', content: "CONSTRUCTION\n\n• Double-click empty space to add beats\n• Drag hexes to move/swap them", tags: ['callback'] },
            { q: 1, r: 0, type: 'note', content: "EDITING\n\n• Click a beat to open the inspector\n• Use the floating bar for quick edits", tags: [] },
            { q: 1, r: 1, type: 'blowoff', content: "WORKFLOW\n\n• Top-Left: Map Library\n• Top-Right: Focus Mode & Theme", tags: ['twist'] }
        ];

        const HexCell = ({ q, r, data, isSelected, theme, zoom, onMouseDown, onDoubleClick }) => {
            const { x, y } = useMemo(() => ({
                x: q * HEX_WIDTH + (r % 2 === 0 ? 0 : HEX_WIDTH / 2),
                y: r * VERT_SPACING
            }), [q, r]);

            const typeData = BEAT_TYPES.find(t => t.id === (data?.type || 'note')) || BEAT_TYPES[4];
            const fill = theme === 'dark' ? typeData.color.dark : typeData.color.light;
            const opacity = data ? 1 : (isSelected ? 0.3 : 0.05);
            const stroke = isSelected 
                ? (theme === 'dark' ? '#fff' : '#432818') 
                : (data ? (theme === 'dark' ? typeData.stroke.dark : 'rgba(67, 40, 24, 0.15)') 
                : (theme === 'dark' ? 'rgba(255,255,255,0.05)' : 'rgba(67, 40, 24, 0.08)'));
            
            const points = useMemo(() => [30, 90, 150, 210, 270, 330].map(a => {
                const rad = (Math.PI / 180) * a;
                return `${x + (HEX_SIZE - 2) * Math.cos(rad)},${y + (HEX_SIZE - 2) * Math.sin(rad)}`;
            }).join(' '), [x, y]);

            const isFarZoom = zoom < 0.5;
            // Scale text inversely with zoom to maintain readability when zoomed out
            const baseSize = isFarZoom ? 22 : 14;
            const scaledFontSize = baseSize / Math.max(0.25, zoom);
            const titleFontSize = Math.min(80, Math.max(18, scaledFontSize));

            return (
                <g 
                    onMouseDown={(e) => onMouseDown(e, q, r)} 
                    onDoubleClick={(e) => { e.preventDefault(); onDoubleClick(e, q, r); }}
                    className="cursor-pointer hex-group select-none"
                >
                    <polygon 
                        points={points} 
                        className="hex-shadow hex-transition"
                        fill={data ? fill : 'transparent'} 
                        fillOpacity={opacity} 
                        stroke={stroke} 
                        strokeWidth={isSelected ? 6 : (data ? 3 : 2)} 
                    />
                    
                    {/* Tags with icons on the hex edge */}
                    {data?.tags?.length > 0 && !isFarZoom && (
                        <g>
                            {data.tags.map((tagId, idx) => {
                                const s = STICKERS.find(st => st.id === tagId);
                                if (!s) return null;
                                // Position tags along the top-right edge of the hex
                                const angle = (-30 + idx * 30) * (Math.PI / 180);
                                const tagX = x + (HEX_SIZE - 12) * Math.cos(angle);
                                const tagY = y + (HEX_SIZE - 12) * Math.sin(angle);
                                return (
                                    <g key={tagId}>
                                        <circle
                                            cx={tagX}
                                            cy={tagY}
                                            r="14"
                                            fill={theme === 'dark' ? 'rgba(0,0,0,0.8)' : 'rgba(255,255,255,0.95)'}
                                            stroke={s.color}
                                            strokeWidth="2"
                                            style={{ filter: 'drop-shadow(0 2px 6px rgba(0,0,0,0.4))' }}
                                        />
                                        <foreignObject x={tagX - 8} y={tagY - 8} width="16" height="16" style={{ pointerEvents: 'none' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', justifyContent: 'center', width: '100%', height: '100%' }}>
                                                <Icon name={s.icon} size={12} style={{ color: s.color }} />
                                            </div>
                                        </foreignObject>
                                    </g>
                                );
                            })}
                        </g>
                    )}

                    {data && (
                        <foreignObject x={x - HEX_WIDTH/2 + 20} y={y - HEX_SIZE + 50} width={HEX_WIDTH - 40} height={HEX_HEIGHT - 100} style={{ pointerEvents: 'none' }}>
                            <div className="w-full h-full flex flex-col items-center justify-center text-center overflow-hidden p-2">
                                {isFarZoom ? (
                                    <h1 className={`font-display font-black leading-tight uppercase tracking-tighter ${theme === 'dark' ? 'text-white' : 'text-[#432818]'}`} 
                                        style={{ 
                                            fontSize: `${titleFontSize}px`, 
                                            textShadow: '0 2px 10px rgba(0,0,0,0.2)',
                                            maxWidth: '100%',
                                            overflow: 'hidden',
                                            textOverflow: 'ellipsis',
                                            display: '-webkit-box',
                                            WebkitLineClamp: 2,
                                            WebkitBoxOrient: 'vertical'
                                        }}>
                                        {data.content.split('\n')[0]}
                                    </h1>
                                ) : (
                                    <span className={`text-[13px] leading-snug line-clamp-5 ${theme === 'dark' ? 'text-gray-100 font-bold' : 'text-gray-800 font-bold'}`}>
                                        {data.content}
                                    </span>
                                )}
                            </div>
                        </foreignObject>
                    )}
                </g>
            );
        };

        const SpineLine = ({ cells, theme }) => {
            const sorted = cells.filter(c => c.type !== 'note').sort((a,b) => a.r - b.r);
            if (sorted.length < 2) return null;

            const pathD = sorted.map((c, i) => {
                const x = c.q * HEX_WIDTH + (c.r % 2 === 0 ? 0 : HEX_WIDTH / 2);
                const y = c.r * VERT_SPACING;
                return (i === 0 ? `M ${x} ${y}` : ` L ${x} ${y}`);
            }).join(' ');

            return (
                <path 
                    d={pathD} 
                    fill="none" 
                    stroke={theme === 'dark' ? '#6366f1' : '#432818'} 
                    strokeWidth="12" 
                    strokeLinecap="round" 
                    strokeLinejoin="round"
                    strokeOpacity="0.4"
                    style={{ pointerEvents: 'none' }}
                />
            );
        };

        function App() {
            // State
            const [user, setUser] = useState(null);
            const [isInitialLoading, setIsInitialLoading] = useState(true);
            const [sketches, setSketches] = useState([]);
            const [currentId, setCurrentId] = useState(null);
            const [cells, setCells] = useState([]);
            const [sketchName, setSketchName] = useState("");
            
            const [theme, setTheme] = useState('dark');
            const [selection, setSelection] = useState({ q: null, r: null });
            const [pan, setPan] = useState({ x: 0, y: 0 });
            const [zoom, setZoom] = useState(1.0);
            
            const [dragState, setDragState] = useState({ active: false, startQ: null, startR: null, dropTarget: null });
            const [quickMenu, setQuickMenu] = useState(null);
            const [libOpen, setLibOpen] = useState(true);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [isCreating, setIsCreating] = useState(false);

            // Refs
            const keysPressed = useRef({});
            const panRef = useRef({ x: 0, y: 0 });
            const dragOrigin = useRef({ x: 0, y: 0 });
            const requestRef = useRef();
            const saveTimeoutRef = useRef(null);
            const cellsRef = useRef([]);
            const nameRef = useRef("");
            const currentIdRef = useRef(null);
            const canvasRef = useRef(null);
            const svgRef = useRef(null);
            const [dimensions, setDimensions] = useState({ w: window.innerWidth, h: window.innerHeight });
            const firebase = useRef({ auth: null, db: null, appId: typeof __app_id !== 'undefined' ? __app_id : 'beathive-v5' });

            useEffect(() => { cellsRef.current = cells; }, [cells]);
            useEffect(() => { nameRef.current = sketchName; }, [sketchName]);
            useEffect(() => { currentIdRef.current = currentId; }, [currentId]);
            useEffect(() => { document.body.className = theme === 'dark' ? 'dark-theme' : 'light-theme'; }, [theme]);

            const loadLocalSketches = () => { try { return JSON.parse(localStorage.getItem(LOCAL_STORAGE_KEY)) || []; } catch(e) { return []; } };
            const saveLocalSketches = (list) => { localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(list)); setSketches(list); };

            useEffect(() => {
                const handleResize = () => setDimensions({ w: window.innerWidth, h: window.innerHeight });
                window.addEventListener('resize', handleResize);

                // Hotkey Zoom Handlers
                const handleZoomKeys = (e) => {
                    if (['TEXTAREA', 'INPUT'].includes(document.activeElement.tagName)) return;
                    if (e.key === '=' || e.key === '+') {
                        setZoom(z => Math.min(3.0, z + 0.1));
                    } else if (e.key === '-') {
                        setZoom(z => Math.max(0.1, z - 0.1));
                    } else if (e.key === '0') {
                        setZoom(1.0);
                        setPan({x:0, y:0});
                    }
                };
                window.addEventListener('keydown', handleZoomKeys);

                const container = canvasRef.current;
                const handleWheel = (e) => {
                    e.preventDefault();
                    if (e.ctrlKey || e.metaKey) {
                        const delta = -e.deltaY * 0.002; 
                        setZoom(z => Math.min(Math.max(0.1, z + delta), 3.0));
                    } else {
                        setPan(p => ({ x: p.x - e.deltaX, y: p.y - e.deltaY }));
                    }
                };

                if (container) container.addEventListener('wheel', handleWheel, { passive: false });
                
                const { initializeApp, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, getFirestore, getDocs, collection, addDoc, serverTimestamp } = window.FirebaseLib;
                const config = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
                
                if (config) {
                    const app = initializeApp(config);
                    firebase.current.auth = getAuth(app);
                    firebase.current.db = getFirestore(app);

                    const initAuthAndSeed = async () => {
                        try {
                            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                await signInWithCustomToken(firebase.current.auth, __initial_auth_token);
                            } else {
                                await signInAnonymously(firebase.current.auth);
                            }
                        } catch (e) {
                            console.error("Auth", e);
                            setUser({ uid: 'guest-' + Math.random().toString(36).substr(2, 9) }); 
                        }
                    };

                    initAuthAndSeed();
                    
                    const unsub = onAuthStateChanged(firebase.current.auth, async (u) => {
                        if (u) {
                            setUser(u);
                            const sketchesCol = collection(firebase.current.db, 'artifacts', firebase.current.appId, 'public', 'data', 'sketches');
                            const snap = await getDocs(sketchesCol);
                            if (snap.empty) {
                                await addDoc(sketchesCol, {
                                    name: "Welcome Map",
                                    cells: WELCOME_CELLS,
                                    owner: u.uid,
                                    createdAt: serverTimestamp(),
                                    updatedAt: serverTimestamp()
                                });
                            }
                            setIsInitialLoading(false);
                        }
                    });
                    return () => { 
                        unsub(); 
                        window.removeEventListener('resize', handleResize);
                        window.removeEventListener('keydown', handleZoomKeys);
                        if (container) container.removeEventListener('wheel', handleWheel);
                    };
                } else {
                    setUser({ uid: 'local-user' });
                    const localData = loadLocalSketches();
                    if (localData.length === 0) {
                        const newMap = { id: 'local-1', name: "Local Demo Map", cells: WELCOME_CELLS, updatedAt: Date.now() };
                        saveLocalSketches([newMap]);
                        setSketches([newMap]);
                        setCurrentId('local-1');
                        setCells(WELCOME_CELLS);
                        setSketchName("Local Demo Map");
                    } else {
                        setSketches(localData);
                        setCurrentId(localData[0].id);
                        setCells(localData[0].cells);
                        setSketchName(localData[0].name);
                    }
                    setIsInitialLoading(false);
                    return () => {
                        window.removeEventListener('resize', handleResize);
                        window.removeEventListener('keydown', handleZoomKeys);
                        if (container) container.removeEventListener('wheel', handleWheel);
                    };
                }
            }, []);

            useEffect(() => {
                if (user?.uid !== 'local-user' && firebase.current.db && !isInitialLoading) {
                    const { collection, query, onSnapshot } = window.FirebaseLib;
                    const q = query(collection(firebase.current.db, 'artifacts', firebase.current.appId, 'public', 'data', 'sketches'));
                    return onSnapshot(q, (snap) => {
                        const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        setSketches(list);
                        if (list.length > 0 && !currentIdRef.current && !isCreating) {
                            setCurrentId(list[0].id);
                        }
                    });
                }
            }, [user, isInitialLoading, isCreating]);

            useEffect(() => {
                if (user?.uid !== 'local-user' && currentId && firebase.current.db) {
                    const { doc, onSnapshot } = window.FirebaseLib;
                    const docRef = doc(firebase.current.db, 'artifacts', firebase.current.appId, 'public', 'data', 'sketches', currentId);
                    return onSnapshot(docRef, (snap) => {
                        if (snap.exists()) {
                            const d = snap.data();
                            setCells(d.cells || []);
                            setSketchName(d.name || "");
                        }
                    });
                } else if (user?.uid === 'local-user' && currentId) {
                    const localData = loadLocalSketches();
                    const active = localData.find(s => s.id === currentId);
                    if (active) {
                        setCells(active.cells || []);
                        setSketchName(active.name || "");
                    }
                }
            }, [user, currentId]);

            const save = useCallback(async (newCells, newName) => {
                const nameToSave = typeof newName === 'string' ? newName : nameRef.current;
                const cellsToSave = newCells || cellsRef.current;

                if (user?.uid === 'local-user') {
                    const localData = loadLocalSketches();
                    const updated = localData.map(s => s.id === currentIdRef.current ? { ...s, name: nameToSave, cells: cellsToSave, updatedAt: Date.now() } : s);
                    saveLocalSketches(updated);
                    setSketchName(nameToSave);
                } else if (firebase.current.db && currentIdRef.current) {
                    const { doc, updateDoc, serverTimestamp } = window.FirebaseLib;
                    try {
                        await updateDoc(doc(firebase.current.db, 'artifacts', firebase.current.appId, 'public', 'data', 'sketches', currentIdRef.current), {
                            cells: cellsToSave,
                            name: nameToSave,
                            updatedAt: serverTimestamp()
                        });
                    } catch (e) { console.error("Save", e); }
                }
            }, [user]);

            const handleNewMap = async () => {
                setIsCreating(true);
                try {
                    const newId = `map-${Date.now()}`;
                    const newData = { name: "New Beat Map", cells: [], owner: user.uid, createdAt: Date.now(), updatedAt: Date.now() };

                    if (user?.uid === 'local-user') {
                        const localData = loadLocalSketches();
                        const newItem = { id: newId, ...newData };
                        saveLocalSketches([...localData, newItem]);
                        setCurrentId(newId);
                        setCells([]);
                        setSketchName("New Beat Map");
                        setSelection({ q: null, r: null });
                    } else if (firebase.current.db) {
                        const { collection, addDoc, serverTimestamp } = window.FirebaseLib;
                        const docRef = await addDoc(collection(firebase.current.db, 'artifacts', firebase.current.appId, 'public', 'data', 'sketches'), {
                            ...newData,
                            createdAt: serverTimestamp(),
                            updatedAt: serverTimestamp()
                        });
                        setCurrentId(docRef.id);
                    }
                } catch(e) { console.error(e); } finally { setIsCreating(false); }
            };

            const handleDeleteMap = async (id, e) => {
                e.stopPropagation();
                if (user?.uid === 'local-user') {
                    const localData = loadLocalSketches();
                    const filtered = localData.filter(s => s.id !== id);
                    saveLocalSketches(filtered);
                    if (currentId === id) {
                        setCurrentId(filtered.length > 0 ? filtered[0].id : null);
                        setCells(filtered.length > 0 ? filtered[0].cells : []);
                        setSketchName(filtered.length > 0 ? filtered[0].name : "");
                    }
                } else if (firebase.current.db) {
                    const { doc, deleteDoc } = window.FirebaseLib;
                    await deleteDoc(doc(firebase.current.db, 'artifacts', firebase.current.appId, 'public', 'data', 'sketches', id));
                    if (currentId === id) {
                        setCurrentId(null);
                        currentIdRef.current = null;
                        setCells([]);
                        setSketchName("");
                    }
                }
            };

            // -- Interactions --
            const handleDoubleClick = (e, q, r) => {
                e.preventDefault();
                setSelection({ q, r });
                setQuickMenu({ x: e.clientX, y: e.clientY, q, r });
                window.getSelection().removeAllRanges();
            };

            const updateCell = (q, r, updates) => {
                const existing = cellsRef.current.find(c => c.q === q && c.r === r);
                const nextCells = existing 
                    ? cellsRef.current.map(c => (c.q === q && c.r === r) ? { ...c, ...updates } : c)
                    : [...cellsRef.current, { q, r, type: 'setup', content: '', tags: [], ...updates }];
                setCells(nextCells);
                
                // Debounce content updates (Audit Rec 4.3)
                if (updates.content !== undefined && Object.keys(updates).length === 1) {
                    if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                    saveTimeoutRef.current = setTimeout(() => save(nextCells), 800);
                } else {
                    // Immediate save for structural changes
                    if (saveTimeoutRef.current) clearTimeout(saveTimeoutRef.current);
                    save(nextCells);
                }
            };

            const handleMouseDown = (e, q, r) => {
                if (e.button !== 0) return;
                setQuickMenu(null);
                dragOrigin.current = { x: e.clientX, y: e.clientY };
                
                setDragState({ active: false, startQ: q, startR: r, dropTarget: { q, r } }); 
            };

            const handleMouseMove = (e) => {
                if (dragState.startQ !== null) {
                    const dist = Math.hypot(e.clientX - dragOrigin.current.x, e.clientY - dragOrigin.current.y);
                    if (dist > 5) {
                        const rect = svgRef.current.getBoundingClientRect();
                        // Use same transform calculation as the SVG group
                        const transformX = dimensions.w/2 + pan.x - (libOpen ? 160 : 0) + (sidebarOpen ? -160 : 0);
                        const transformY = dimensions.h/2 + pan.y - 40;
                        const adjX = (e.clientX - rect.left - transformX) / zoom;
                        const adjY = (e.clientY - rect.top - transformY) / zoom;
                        let r = Math.round(adjY / VERT_SPACING);
                        let q = Math.round((adjX - (r % 2 === 0 ? 0 : HEX_WIDTH / 2)) / HEX_WIDTH);
                        setDragState(prev => ({ ...prev, active: true, dropTarget: { q, r } }));
                    }
                } else if (e.buttons === 1) {
                    setPan(p => {
                        const next = { x: p.x + e.movementX, y: p.y + e.movementY };
                        panRef.current = next;
                        return next;
                    });
                }
            };

            const handleMouseUp = () => {
                if (dragState.active && dragState.dropTarget) {
                    const { startQ, startR, dropTarget } = dragState;
                    if (dropTarget.q !== startQ || dropTarget.r !== startR) {
                        const source = cellsRef.current.find(c => c.q === startQ && c.r === startR);
                        let next = cellsRef.current.filter(c => !(c.q === startQ && c.r === startR) && !(c.q === dropTarget.q && c.r === dropTarget.r));
                        if (source) next.push({ ...source, q: dropTarget.q, r: dropTarget.r });
                        setCells(next); save(next); setSelection(dropTarget);
                    }
                } else if (dragState.startQ !== null) {
                    setSelection({ q: dragState.startQ, r: dragState.startR });
                }
                setDragState({ active: false, startQ: null, startR: null, dropTarget: null });
            };

            // WASD Movement
            useEffect(() => {
                const moveLoop = () => {
                    if (document.activeElement.tagName === 'TEXTAREA' || document.activeElement.tagName === 'INPUT') {
                        requestRef.current = requestAnimationFrame(moveLoop);
                        return;
                    }
                    const speed = 12 / zoom; 
                    let dx = 0, dy = 0;
                    if (keysPressed.current['w'] || keysPressed.current['arrowup']) dy += speed;
                    if (keysPressed.current['s'] || keysPressed.current['arrowdown']) dy -= speed;
                    if (keysPressed.current['a'] || keysPressed.current['arrowleft']) dx += speed;
                    if (keysPressed.current['d'] || keysPressed.current['arrowright']) dx -= speed;
                    if (dx !== 0 || dy !== 0) {
                        panRef.current = { x: panRef.current.x + dx, y: panRef.current.y + dy };
                        setPan({ ...panRef.current });
                    }
                    requestRef.current = requestAnimationFrame(moveLoop);
                };

                const handleKeyDown = (e) => {
                    keysPressed.current[e.key.toLowerCase()] = true;
                    if (!['TEXTAREA', 'INPUT'].includes(document.activeElement.tagName)) {
                        if ((e.key === 'Delete' || e.key === 'Backspace') && selection.q !== null) {
                            const next = cellsRef.current.filter(c => !(c.q === selection.q && c.r === selection.r));
                            setCells(next); save(next); setSelection({ q: null, r: null });
                        }
                    }
                };
                const handleKeyUp = (e) => keysPressed.current[e.key.toLowerCase()] = false;

                window.addEventListener('keydown', handleKeyDown);
                window.addEventListener('keyup', handleKeyUp);
                requestRef.current = requestAnimationFrame(moveLoop);
                return () => {
                    window.removeEventListener('keydown', handleKeyDown);
                    window.removeEventListener('keyup', handleKeyUp);
                    cancelAnimationFrame(requestRef.current);
                };
            }, [zoom, selection, save]);

            const centerX = useMemo(() => {
                let x = dimensions.w / 2;
                if (!libOpen && sidebarOpen) x -= 160;
                if (libOpen && !sidebarOpen) x += 140;
                return x;
            }, [dimensions, libOpen, sidebarOpen]);
            const centerY = dimensions.h / 2.2;

            const selectedCell = cells.find(c => c.q === selection.q && c.r === selection.r);

            // Optimization 4.1: Memoize Grid Generation
            const visibleGrid = useMemo(() => {
                const centerR = Math.round(-pan.y / VERT_SPACING / zoom);
                const centerQ = Math.round(-pan.x / HEX_WIDTH / zoom);
                
                return Array.from({length: 16}).flatMap((_, r_idx) => {
                    const r = r_idx - 8 + centerR;
                    return Array.from({length: 16}).map((__, q_idx) => {
                        const q = q_idx - 8 + centerQ;
                        const cData = cells.find(c => c.q === q && c.r === r);
                        return <HexCell key={`g-${q}-${r}`} q={q} r={r} data={cData} theme={theme} zoom={zoom} isSelected={selection.q === q && selection.r === r} onMouseDown={handleMouseDown} onDoubleClick={handleDoubleClick} />;
                    });
                });
            }, [cells, selection, theme, zoom, Math.round(pan.x / HEX_WIDTH / zoom), Math.round(pan.y / VERT_SPACING / zoom)]);

            if (isInitialLoading) return (
                <div className="w-full h-screen bg-black flex items-center justify-center flex-col gap-6">
                    <div className="w-16 h-16 border-4 border-indigo-600 border-t-transparent rounded-full animate-spin"></div>
                    <div className="text-white/30 font-black tracking-[0.4em] uppercase text-xs animate-pulse">Initializing System</div>
                </div>
            );

            return (
                <div className={`w-full h-screen flex flex-col transition-all duration-500 ${theme === 'dark' ? 'dark-theme' : 'light-theme'}`}>
                    <header className={`h-16 flex items-center justify-between px-6 border-b transition-colors ${theme === 'dark' ? 'border-white/5 bg-black/50' : 'border-stone-400/20 bg-[#e6e0d4]/80'} backdrop-blur-xl z-50`}>
                        <div className="flex items-center gap-4">
                            <button onClick={() => setLibOpen(!libOpen)} aria-label="Toggle Library" className={`p-2 rounded-lg transition-all ${libOpen ? 'bg-indigo-600 text-white shadow-lg' : 'hover:bg-black/10 opacity-60'}`}><Icon name="folder" size={18}/></button>
                            <input value={sketchName} onChange={(e) => { setSketchName(e.target.value); save(null, e.target.value); }} aria-label="Project Name" className="bg-transparent font-display font-bold text-lg outline-none w-48 sm:w-64" placeholder="Untitled Hive" />
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 px-2">
                                <Icon name="zoomOut" size={12} className="opacity-50"/>
                                <input 
                                    type="range" min="0.1" max="3" step="0.1" 
                                    value={zoom} 
                                    onChange={(e) => setZoom(parseFloat(e.target.value))}
                                    aria-label="Zoom Level"
                                    className="w-20 h-1 bg-current opacity-20 rounded-lg appearance-none cursor-pointer"
                                />
                                <Icon name="zoomIn" size={12} className="opacity-50"/>
                            </div>
                            <button onClick={() => setTheme(t => t === 'dark' ? 'light' : 'dark')} aria-label="Toggle Theme" className="p-2 opacity-50 hover:opacity-100"><Icon name={theme === 'dark' ? 'sun' : 'moon'} size={20}/></button>
                            <button onClick={() => setSidebarOpen(!sidebarOpen)} aria-label="Toggle Inspector" className={`p-2 rounded-lg transition-all ${sidebarOpen ? 'bg-indigo-600 text-white shadow-lg' : 'hover:bg-black/10 opacity-60'}`}><Icon name="mask" size={18}/></button>
                        </div>
                    </header>

                    <main className="flex-1 flex overflow-hidden relative">
                        <aside className={`sidebar-panel border-r backdrop-blur-sm ${libOpen ? 'w-[320px]' : 'w-0'}`}>
                            <div className="sidebar-inner p-6 space-y-6">
                                <button onClick={handleNewMap} disabled={isCreating} aria-label="New Map" className="w-full py-4 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl font-bold text-xs tracking-widest uppercase flex items-center justify-center gap-3 shadow-xl transition-all active:scale-95 disabled:opacity-50">
                                    <Icon name="plus" size={14}/> New Universe
                                </button>
                                <div className="flex-1 overflow-y-auto space-y-2 no-scrollbar pr-2">
                                    {sketches.map(s => (
                                        <div key={s.id} onClick={() => setCurrentId(s.id)} className={`group flex items-center justify-between p-4 rounded-xl cursor-pointer transition-all ${currentId === s.id ? 'bg-indigo-500/10 border border-indigo-500/30 text-indigo-500 font-bold' : 'opacity-60 hover:opacity-100 hover:bg-current/5'}`}>
                                            <span className="text-xs truncate px-1">{s.name || "Untitled"}</span>
                                            <button onClick={(e) => handleDeleteMap(s.id, e)} aria-label="Delete Map" className="opacity-0 group-hover:opacity-100 p-2 hover:bg-red-500/20 hover:text-red-500 rounded-lg transition-all"><Icon name="trash" size={14}/></button>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        </aside>

                        <div ref={canvasRef} className={`flex-1 relative cursor-grab active:cursor-grabbing overflow-hidden transition-all duration-300 ${theme === 'dark' ? 'bg-grid-dark' : 'bg-grid-light'}`} 
                             onMouseDown={(e) => { if(e.target.tagName === 'svg') setSelection({q:null, r:null}); }}
                             onMouseMove={handleMouseMove}
                             onMouseUp={handleMouseUp}
                             onMouseLeave={() => setDragState({ active: false, startQ: null, startR: null, dropTarget: null })}>
                            <svg ref={svgRef} className="w-full h-full">
                                <g transform={`translate(${window.innerWidth/2 + pan.x - (libOpen ? 160 : 0) + (sidebarOpen ? -160 : 0)}, ${window.innerHeight/2 + pan.y - 40}) scale(${zoom})`}>
                                    
                                    {/* Infinite Grid Simulation (Optimized) */}
                                    {visibleGrid}

                                    {/* Active Hexes (Foreground) */}
                                    {cells.map(c => <HexCell key={`active-${c.q},${c.r}`} q={c.q} r={c.r} data={c} theme={theme} zoom={zoom} isSelected={selection.q === c.q && selection.r === c.r} onMouseDown={handleMouseDown} onDoubleClick={handleDoubleClick} />)}

                                    {/* Drag Ghost */}
                                    {dragState.active && dragState.dropTarget && (
                                         <HexCell q={dragState.dropTarget.q} r={dragState.dropTarget.r} isSelected={true} theme={theme} zoom={zoom} onMouseDown={()=>{}} onDoubleClick={()=>{}} />
                                    )}

                                    {/* Spine Line - Rendered Last */}
                                    <SpineLine cells={cells} theme={theme} />
                                </g>
                            </svg>
                            {/* Floating Status */}
                            <div className="absolute bottom-8 left-8 flex flex-col gap-2 pointer-events-none animate-in">
                                <div className={`px-5 py-3 rounded-full border text-[10px] font-black uppercase tracking-[0.2em] shadow-2xl ${theme === 'dark' ? 'bg-black/80 border-white/10 text-white/50' : 'bg-white/80 border-black/5 text-black/50'}`}>
                                    {selection.q !== null ? 'Node Selected' : 'Hive Ready'}
                                </div>
                            </div>

                            {/* Minimap */}
                            {cells.length > 0 && (
                                <div className="minimap" onClick={(e) => {
                                    const rect = e.currentTarget.getBoundingClientRect();
                                    const clickX = e.clientX - rect.left;
                                    const clickY = e.clientY - rect.top;

                                    // Calculate bounds
                                    const qs = cells.map(c => c.q);
                                    const rs = cells.map(c => c.r);
                                    const minQ = Math.min(...qs), maxQ = Math.max(...qs);
                                    const minR = Math.min(...rs), maxR = Math.max(...rs);
                                    const padding = 2;

                                    const rangeQ = (maxQ - minQ + padding * 2) || 1;
                                    const rangeR = (maxR - minR + padding * 2) || 1;

                                    // Map click to world coordinates
                                    const targetQ = minQ - padding + (clickX / 150) * rangeQ;
                                    const targetR = minR - padding + (clickY / 120) * rangeR;

                                    const worldX = targetQ * HEX_WIDTH + (Math.round(targetR) % 2 === 0 ? 0 : HEX_WIDTH / 2);
                                    const worldY = targetR * VERT_SPACING;

                                    setPan({ x: -worldX * zoom, y: -worldY * zoom });
                                    panRef.current = { x: -worldX * zoom, y: -worldY * zoom };
                                }}>
                                    <svg width="150" height="120" style={{ display: 'block' }}>
                                        {(() => {
                                            const qs = cells.map(c => c.q);
                                            const rs = cells.map(c => c.r);
                                            const minQ = Math.min(...qs), maxQ = Math.max(...qs);
                                            const minR = Math.min(...rs), maxR = Math.max(...rs);
                                            const padding = 2;

                                            const rangeQ = (maxQ - minQ + padding * 2) || 1;
                                            const rangeR = (maxR - minR + padding * 2) || 1;
                                            const scaleX = 150 / rangeQ;
                                            const scaleY = 120 / rangeR;
                                            const scale = Math.min(scaleX, scaleY) * 0.8;

                                            return cells.map(c => {
                                                const nx = (c.q - minQ + padding) * scale + 10;
                                                const ny = (c.r - minR + padding) * scale + 10;
                                                const typeData = BEAT_TYPES.find(t => t.id === c.type) || BEAT_TYPES[4];
                                                const fill = theme === 'dark' ? typeData.color.dark : typeData.color.light;
                                                return <circle key={`mm-${c.q}-${c.r}`} cx={nx} cy={ny} r={4} fill={fill} />;
                                            });
                                        })()}
                                    </svg>
                                </div>
                            )}
                            
                            {/* Quick Menu */}
                            {quickMenu && (
                                <div className="fixed z-[100] animate-in" style={{ left: quickMenu.x, top: quickMenu.y }}>
                                    <div className={`p-2 rounded-3xl shadow-2xl border w-64 ${theme === 'dark' ? 'bg-zinc-900 border-white/10' : 'bg-[#e6e0d4] border-[#432818]/10'}`}>
                                        <div className="px-4 py-3 text-[10px] font-black uppercase tracking-widest opacity-30">Select Archetype</div>
                                        {BEAT_TYPES.map(t => (
                                            <button key={t.id} onClick={(e) => { e.stopPropagation(); updateCell(quickMenu.q, quickMenu.r, { type: t.id }); setQuickMenu(null); }} className={`w-full text-left px-4 py-3 rounded-2xl text-xs font-bold transition-all flex items-center gap-3 ${theme === 'dark' ? 'hover:bg-white/5' : 'hover:bg-black/5'}`}>
                                                <div className="w-2 h-2 rounded-full ring-2 ring-offset-2 ring-offset-transparent" style={{ backgroundColor: theme === 'dark' ? t.color.dark : t.color.light, '--tw-ring-color': theme === 'dark' ? t.color.dark : t.color.light }}></div>
                                                {t.label}
                                            </button>
                                        ))}
                                        <div className={`border-t my-2 ${theme === 'dark' ? 'border-white/10' : 'border-black/10'}`}></div>
                                        <div className="px-4 py-2 text-[10px] font-black uppercase tracking-widest opacity-30">Story Tags</div>
                                        <div className="px-2 pb-2 flex flex-wrap gap-1">
                                            {STICKERS.map(s => {
                                                const existingCell = cells.find(c => c.q === quickMenu.q && c.r === quickMenu.r);
                                                const isActive = existingCell?.tags?.includes(s.id);
                                                return (
                                                    <button
                                                        key={s.id}
                                                        onClick={(e) => {
                                                            e.stopPropagation();
                                                            const currentTags = existingCell?.tags || [];
                                                            const newTags = isActive
                                                                ? currentTags.filter(t => t !== s.id)
                                                                : [...currentTags, s.id];
                                                            updateCell(quickMenu.q, quickMenu.r, { tags: newTags });
                                                        }}
                                                        className={`p-2 rounded-xl transition-all ${isActive ? 'scale-110 shadow-lg' : 'opacity-40 hover:opacity-100'}`}
                                                        style={{ backgroundColor: isActive ? s.color + '30' : 'transparent' }}
                                                        title={s.label}
                                                    >
                                                        <Icon name={s.icon} size={16} style={{ color: s.color }} />
                                                    </button>
                                                );
                                            })}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Floating Editor */}
                            {selectedCell && !sidebarOpen && (
                                <div className="fixed z-50 bottom-16 left-1/2 -translate-x-1/2 w-full max-w-lg px-4 animate-in">
                                    <div className={`p-1 rounded-2xl shadow-2xl backdrop-blur-xl border ${theme === 'dark' ? 'bg-zinc-900/90 border-white/10' : 'bg-[#e6e0d4]/90 border-[#432818]/10'}`}>
                                        <div className="flex items-center justify-between px-4 py-2 border-b border-inherit opacity-50">
                                            <span className="text-[9px] font-black uppercase tracking-widest flex items-center gap-2">
                                                <div className="w-1.5 h-1.5 rounded-full" style={{ backgroundColor: theme === 'dark' ? (BEAT_TYPES.find(t => t.id === selectedCell.type) || BEAT_TYPES[4]).color.dark : (BEAT_TYPES.find(t => t.id === selectedCell.type) || BEAT_TYPES[4]).color.light }}></div>
                                                {(BEAT_TYPES.find(t => t.id === selectedCell.type) || BEAT_TYPES[4]).label}
                                            </span>
                                            <span className="text-[9px] font-black uppercase tracking-widest">Quick Edit (Enter to Exit)</span>
                                        </div>
                                        <div className="flex gap-1 px-3 py-2 border-b border-inherit">
                                            {STICKERS.map(s => {
                                                const isActive = selectedCell.tags?.includes(s.id);
                                                return (
                                                    <button
                                                        key={s.id}
                                                        onClick={() => {
                                                            const currentTags = selectedCell.tags || [];
                                                            const newTags = isActive
                                                                ? currentTags.filter(t => t !== s.id)
                                                                : [...currentTags, s.id];
                                                            updateCell(selection.q, selection.r, { tags: newTags });
                                                        }}
                                                        className={`p-1.5 rounded-lg transition-all ${isActive ? 'scale-110' : 'opacity-30 hover:opacity-100'}`}
                                                        style={{ backgroundColor: isActive ? s.color + '30' : 'transparent' }}
                                                        title={s.label}
                                                    >
                                                        <Icon name={s.icon} size={14} style={{ color: s.color }} />
                                                    </button>
                                                );
                                            })}
                                        </div>
                                        <textarea
                                            className={`w-full bg-transparent p-4 resize-none outline-none text-sm font-medium leading-relaxed h-32 ${theme === 'dark' ? 'text-white placeholder-white/20' : 'text-[#432818] placeholder-[#432818]/40'}`}
                                            placeholder="Describe this beat..."
                                            value={selectedCell.content}
                                            onChange={(e) => updateCell(selection.q, selection.r, { content: e.target.value })}
                                            onKeyDown={(e) => {
                                                if (e.key === 'Enter' && !e.shiftKey) {
                                                    e.preventDefault();
                                                    setSelection({ q: null, r: null });
                                                }
                                                if (e.key === 'Escape') {
                                                    e.preventDefault();
                                                    setSelection({ q: null, r: null });
                                                }
                                            }}
                                            autoFocus
                                        />
                                    </div>
                                </div>
                            )}
                        </div>

                        <aside className={`sidebar-panel border-l backdrop-blur-sm ${sidebarOpen ? 'w-[320px]' : 'w-0'}`}>
                            <div className="sidebar-inner p-8 space-y-8">
                                {selectedCell ? (
                                    <>
                                        <div className="space-y-4">
                                            <label className="text-[10px] font-black opacity-30 uppercase tracking-[0.2em]">Archetype</label>
                                            <div className="flex flex-col gap-2">
                                                {BEAT_TYPES.map(t => (
                                                    <button key={t.id} onClick={() => updateCell(selection.q, selection.r, { type: t.id })} className={`w-full text-left px-4 py-3 rounded-xl text-[11px] font-bold transition-all border ${selectedCell.type === t.id ? 'bg-indigo-600 text-white border-indigo-500 shadow-lg scale-[1.02]' : 'bg-current/5 border-transparent hover:bg-current/10'}`}>
                                                        {t.label}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="space-y-4">
                                            <label className="text-[10px] font-black opacity-30 uppercase tracking-[0.2em]">Story Tags</label>
                                            <div className="flex flex-wrap gap-2">
                                                {STICKERS.map(s => {
                                                    const isActive = selectedCell.tags?.includes(s.id);
                                                    return (
                                                        <button
                                                            key={s.id}
                                                            onClick={() => {
                                                                const currentTags = selectedCell.tags || [];
                                                                const newTags = isActive
                                                                    ? currentTags.filter(t => t !== s.id)
                                                                    : [...currentTags, s.id];
                                                                updateCell(selection.q, selection.r, { tags: newTags });
                                                            }}
                                                            className={`flex items-center gap-2 px-3 py-2 rounded-lg text-[10px] font-bold transition-all border ${isActive ? 'border-current scale-105 shadow-lg' : 'border-transparent opacity-50 hover:opacity-100'}`}
                                                            style={{ backgroundColor: isActive ? s.color + '30' : 'transparent', borderColor: isActive ? s.color : 'transparent' }}
                                                        >
                                                            <Icon name={s.icon} size={14} style={{ color: s.color }} />
                                                            {s.label}
                                                        </button>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                        <div className="flex-1 flex flex-col space-y-4">
                                            <label className="text-[10px] font-black opacity-30 uppercase tracking-[0.2em]">Narrative Log</label>
                                            <textarea className={`flex-1 w-full p-5 rounded-2xl resize-none outline-none text-sm leading-relaxed transition-all shadow-inner ${theme === 'dark' ? 'bg-black/40 border border-white/5 focus:border-indigo-500/50' : 'bg-white border border-black/5 focus:border-indigo-500/50'}`}
                                                      value={selectedCell.content}
                                                      placeholder="Describe the moment..."
                                                      onChange={(e) => updateCell(selection.q, selection.r, { content: e.target.value })} />
                                        </div>
                                        <button onClick={() => {
                                            const next = cells.filter(c => !(c.q === selection.q && c.r === selection.r));
                                            setCells(next); save(next); setSelection({q:null, r:null});
                                        }} className="w-full py-4 bg-red-500/10 text-red-500 rounded-2xl font-black text-[10px] uppercase tracking-[0.2em] hover:bg-red-500/20 transition-all">
                                            Purge Node
                                        </button>
                                    </>
                                ) : (
                                    <div className="h-full flex flex-col items-center justify-center text-center opacity-20 space-y-6">
                                        <div className="p-6 bg-current/10 rounded-full animate-pulse-slow">
                                            <Icon name="mask" size={40}/>
                                        </div>
                                        <p className="text-xs font-black uppercase tracking-widest leading-loose max-w-[200px]">Select a hex node to access the architect console</p>
                                    </div>
                                )}
                            </div>
                        </aside>
                    </main>

                    <footer className={`h-12 px-8 flex items-center justify-between border-t border-inherit bg-current/5 text-[10px] font-bold opacity-40 uppercase tracking-widest`}>
                        <div className="flex gap-6">
                            <span className="flex items-center gap-2"><span className={`w-1.5 h-1.5 rounded-full animate-pulse ${user?.uid === 'local-user' ? 'bg-amber-500' : 'bg-emerald-500'}`}></span> {user?.uid === 'local-user' ? 'Local Storage' : 'Network Active'}</span>
                            <span>{user?.uid === 'local-user' ? 'Offline Mode' : `UID: ${user.uid.slice(0,8)}...`}</span>
                        </div>
                        <a href="index.html" className="hover:opacity-100 transition-opacity" style={{textDecoration: 'none', color: 'inherit'}}>Writing Tools Suite</a>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>